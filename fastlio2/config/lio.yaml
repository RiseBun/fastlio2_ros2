# ==============================================================================
# FASTLIO2 ROS2 配置文件
# ==============================================================================
# 本文件包含FASTLIO2系统的所有可配置参数
# 修改参数后需要重新启动FASTLIO2节点才能生效
# ==============================================================================

# ==============================================================================
# 第一部分：传感器话题配置
# ==============================================================================
# 这些参数定义了系统订阅的ROS2话题名称和坐标系
# 根据实际使用的传感器进行调整

# IMU数据话题名称
# 类型: sensor_msgs/msg/Imu
# Livox MID-360默认话题: /livox/imu
# 注意: IMU频率应不低于100Hz以保证状态估计精度
imu_topic: /livox/imu

# LiDAR点云话题名称
# 类型: livox_ros_driver2/msg/CustomMsg (Livox专用消息类型)
# Livox MID-360默认话题: /livox/lidar
# 注意: 如果使用标准PointCloud2消息,需要修改源代码中的订阅类型
lidar_topic: /livox/lidar

# 机体坐标系名称
# 用于TF变换发布,表示传感器/机器人本体坐标系
body_frame: body

# 世界坐标系名称
# 用于TF变换发布,表示全局/地图坐标系
# 建图结果将以此坐标系为参考
world_frame: lidar

# 是否打印每帧处理时间
# true: 在终端输出每次处理的耗时信息,用于性能调试
# false: 正常运行模式,减少输出
print_time_cost: false

# ==============================================================================
# 第二部分：点云预处理参数
# ==============================================================================
# 这些参数控制输入点云的过滤和降采样
# 直接影响系统的计算量和建图精度

# 点云抽样率 (每N个点取1个)
# 范围: 1-10
# 影响: 值越大,处理的点越少,计算越快,但可能丢失细节
# 建议: 室内场景用3-6,室外大场景用6-10
# 低配硬件(如Jetson)建议增大此值
lidar_filter_num: 6

# LiDAR最小有效距离 (单位: 米)
# 小于此距离的点将被过滤
# 用途: 过滤传感器盲区和自身反射的点
# 建议: 根据传感器规格设置,Livox MID-360建议0.5m
lidar_min_range: 0.5

# LiDAR最大有效距离 (单位: 米)
# 大于此距离的点将被过滤
# 影响: 值越大,包含的远处点越多,但远处点精度较低
# 建议: 室内15-30m,室外50-100m
lidar_max_range: 30.0

# 扫描点云体素降采样分辨率 (单位: 米)
# 每个体素内只保留一个代表点
# 影响: 值越大,点云越稀疏,计算越快,精度可能降低
# 建议: 0.1-0.3m,需要平衡精度和效率
scan_resolution: 0.15

# 地图点云体素降采样分辨率 (单位: 米)
# 控制ikd-Tree中地图点的密度
# 影响: 值越大,地图越稀疏,内存占用越小
# 建议: 通常设为scan_resolution的1.5-2倍
map_resolution: 0.3

# ==============================================================================
# 第三部分：ikd-Tree地图参数
# ==============================================================================
# ikd-Tree是FAST-LIO2的核心数据结构,用于维护局部地图

# 地图立方体边长 (单位: 米)
# 定义ikd-Tree维护的地图空间大小
# 超出此范围的点将被自动删除
# 影响: 值越大,可覆盖的场景越大,但内存占用增加
# 建议: 室内100-200m,室外300-500m
cube_len: 300

# 有效探测范围 (单位: 米)
# 定义ikd-Tree中用于状态估计的点的最大距离
# 影响: 值越大,参与匹配的点越多,计算量增加
# 建议: 通常设为lidar_max_range的1.5-2倍
det_range: 60

# 地图移动阈值 (单位: 米)
# 当机器人移动超过此距离时,触发地图裁剪
# 影响: 值越小,裁剪越频繁,地图越紧凑
# 建议: 1.0-2.0m
move_thresh: 1.5

# ==============================================================================
# 第四部分：IMU噪声参数
# ==============================================================================
# 这些参数描述IMU传感器的噪声特性
# 需要根据传感器数据手册或标定结果设置
# 错误的噪声参数会导致状态估计不准确

# 加速度计噪声密度 (单位: m/s²/√Hz)
# 描述加速度计测量的随机噪声强度
# 获取方式: 查阅传感器数据手册或通过Allan方差标定
# Livox MID-360典型值: 0.01
na: 0.01

# 陀螺仪噪声密度 (单位: rad/s/√Hz)
# 描述陀螺仪测量的随机噪声强度
# 获取方式: 查阅传感器数据手册或通过Allan方差标定
# Livox MID-360典型值: 0.01
ng: 0.01

# 加速度计偏置随机游走 (单位: m/s³/√Hz)
# 描述加速度计偏置的漂移速率
# 影响: 值越大,滤波器对偏置变化的响应越快
# 典型值: 0.0001-0.001
nba: 0.0001

# 陀螺仪偏置随机游走 (单位: rad/s²/√Hz)
# 描述陀螺仪偏置的漂移速率
# 影响: 值越大,滤波器对偏置变化的响应越快
# 典型值: 0.0001-0.001
nbg: 0.0001

# ==============================================================================
# 第五部分：IESKF滤波器参数
# ==============================================================================
# IESKF (迭代误差状态卡尔曼滤波器) 是系统的核心算法

# IMU初始化帧数
# 系统启动时需要收集的IMU数据帧数,用于初始化重力方向和IMU偏置
# 影响: 值越大,初始化越稳定,但启动时间越长
# 建议: 10-30帧
imu_init_num: 20

# 近邻搜索点数
# ikd-Tree近邻搜索时返回的最近点数量
# 用于计算点到平面的残差
# 影响: 值越大,平面拟合越稳定,但计算量增加
# 建议: 5-8个点
near_search_num: 5

# IESKF最大迭代次数
# 每帧数据的迭代优化次数上限
# 影响: 值越大,单帧精度可能越高,但耗时增加
# 建议: 3-5次,通常3次即可收敛
ieskf_max_iter: 5

# ==============================================================================
# 第六部分：初始化与外参配置
# ==============================================================================

# 是否启用重力对齐
# true: 使用IMU数据估计初始重力方向
# false: 假设初始姿态为水平
# 建议: 保持true,提高初始化稳定性
gravity_align: true

# 是否在线估计IMU-LiDAR外参
# true: 系统会尝试优化IMU和LiDAR之间的外参
# false: 使用预设的外参值
# 注意: 需要足够的运动激励才能准确估计
# 建议: 如果外参已精确标定,设为false
esti_il: false

# IMU-LiDAR旋转外参 (3x3旋转矩阵,按行展开)
# 定义从IMU坐标系到LiDAR坐标系的旋转变换
# 格式: [r11, r12, r13, r21, r22, r23, r31, r32, r33]
# 单位矩阵表示两个坐标系对齐
r_il: [1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0]

# IMU-LiDAR平移外参 (3x1向量)
# 定义从IMU原点到LiDAR原点的平移向量,在IMU坐标系下表示
# 格式: [x, y, z] (单位: 米)
# Livox MID-360参考值: [-0.011, -0.02329, 0.04412]
t_il: [-0.011, -0.02329, 0.04412]

# LiDAR测量协方差的逆
# 控制LiDAR测量在滤波器中的权重
# 影响: 值越大,LiDAR测量权重越高
# 建议: 500-2000,根据LiDAR精度调整
lidar_cov_inv: 1000.0

# ==============================================================================
# 第七部分：关键帧管理参数
# ==============================================================================
# 关键帧是建图和回环检测的基础单元
# 合理的关键帧选择策略对系统性能至关重要

# 关键帧距离阈值 (单位: 米)
# 当机器人相对上一关键帧移动距离超过此值时,插入新关键帧
# 影响: 值越小,关键帧越密集,建图越精细,但数据量增加
# 建议: 室内0.5-1.0m,室外1.0-2.0m
keyframe_dist_threshold: 1.0

# 关键帧角度阈值 (单位: 弧度)
# 当机器人相对上一关键帧旋转角度超过此值时,插入新关键帧
# 0.2 rad ≈ 11.5°
# 影响: 值越小,旋转时关键帧越密集
# 建议: 0.1-0.3 rad
keyframe_angle_threshold: 0.2

# ==============================================================================
# 第八部分：回环检测参数
# ==============================================================================
# 回环检测用于识别机器人重访的位置,消除累积漂移
# 采用三级验证机制: 距离搜索 -> ScanContext -> ICP

# 是否启用回环检测
# true: 启用回环检测和位姿图优化
# false: 仅进行里程计,不进行全局优化
# 注意: 启用回环检测会增加计算量和内存占用
loop_closure_enable: true

# 回环检测频率 (单位: Hz)
# 回环检测线程的执行频率
# 影响: 值越大,回环检测越及时,但CPU占用增加
# 建议: 长时间运行时用0.5Hz节省计算资源
loop_closure_frequency: 0.5

# 回环搜索半径 (单位: 米)
# 在此半径范围内搜索候选回环帧
# 影响: 值越大,搜索范围越大,但误匹配风险增加
# 建议: 10-25m,应大于keyframe_dist_threshold的10倍以上
loop_search_radius: 15.0

# 回环时间差阈值 (单位: 秒)
# 候选回环帧与当前帧的最小时间间隔
# 用途: 避免将时间上相近的帧误判为回环
# 影响: 值越大,回环检测越保守
# 建议: 20-60秒
loop_time_diff_threshold: 30.0

# ScanContext距离阈值
# ScanContext是一种旋转不变的场景描述子
# 两个描述子的距离小于此阈值时认为是潜在回环
# 范围: 0-1,值越小越严格
# 影响: 值越小,回环检测越严格,召回率降低但精度提高
# 建议: 结构化环境0.15-0.20,复杂环境0.25-0.35
sc_dist_threshold: 0.20

# ICP适配度阈值
# ICP(迭代最近点)配准的收敛指标
# 值越小表示点云对齐越好
# 影响: 值越小,回环验证越严格
# 建议: 0.3-0.8,高重复场景用较小值
icp_fitness_threshold: 0.5

# 子图大小 (关键帧数量)
# ICP匹配时使用的局部子图包含的关键帧数量
# 影响: 值越大,子图越完整,匹配越稳定,但计算量增加
# 建议: 15-30帧
submap_size: 25

# ==============================================================================
# 第九部分：地图保存配置
# ==============================================================================
# 控制地图和相关数据的保存行为

# 退出时是否自动保存地图
# true: 节点退出(Ctrl+C)时自动保存地图到map_save_path
# false: 需要手动调用服务保存
save_map_on_exit: true

# 地图保存路径
# 地图文件的默认保存目录
# 将创建包含点云、位姿、描述子等文件的完整目录结构
map_save_path: "/home/li/maps"

# 是否保存关键帧点云
# true: 保存每个关键帧的独立点云文件到patches/目录
# false: 仅保存全局地图
# 用途: 关键帧点云用于重定位和增量建图
save_patches: true

# ==============================================================================
# 第十部分：扩展保存选项 (兼容fast_lio_sam格式)
# ==============================================================================

# 是否保存KITTI格式轨迹文件
# 生成: optimized_pose.txt (优化后) 和 without_optimized_pose.txt (优化前)
# 格式: 每行12个数字,表示3x4变换矩阵 [R|t]
# 用途: 轨迹评估、对比分析
save_trajectory_txt: true

# 是否保存ScanContext描述子文件
# 生成: scd/目录下的*.scd二进制文件
# 用途: 重定位时的场景匹配
save_scd_files: true

# 是否保存位姿图文件
# 生成: pose_graph.g2o
# 格式: G2O格式,包含顶点(位姿)和边(约束)
# 用途: 离线优化、增量建图
save_pose_graph: true

# 是否保存性能日志
# 生成: fast_lio_time_log.csv
# 内容: 每帧的处理时间、点数等统计信息
# 用途: 性能分析和调试
save_performance_log: true

# ==============================================================================
# 第十一部分：内存管理参数 (嵌入式平台优化)
# ==============================================================================
# 这些参数用于控制内存使用,特别适用于Jetson Orin等资源受限平台
# 针对长时间运行场景(40分钟/2-4公里)已优化

# 保留点云的最大关键帧数量
# 超过此数量后,旧关键帧的点云将被释放以节省内存
# 位姿信息仍然保留,仅释放点云数据
# 影响: 值越小,内存占用越低,但回环检测的子图构建可能受影响
# 建议: 8GB内存设备用300,16GB用500-1000
# 长时间运行建议: 300-400帧,配合增量保存使用
max_keyframes_with_cloud: 500

# 是否启用自动点云清理
# true: 自动释放旧关键帧的点云内存
# false: 保留所有关键帧点云(可能导致内存溢出)
# 建议: 嵌入式平台和长时间运行务必启用
enable_cloud_cleanup: true

# 关键帧点云降采样分辨率 (单位: 米)
# 存储前对关键帧点云进行降采样
# 0或负值: 不进行降采样
# 影响: 值越大,每个关键帧占用内存越小
# 建议: 长时间运行建议0.18-0.25,平衡内存和精度
keyframe_cloud_res: 0.20

# ==============================================================================
# 第十二部分：增量保存配置 (长时间运行必备)
# ==============================================================================
# 用于长时间运行任务,定期保存数据防止丢失
# 增量保存现已支持完整的重定位数据格式(PCD+SCD+KITTI位姿)

# 是否启用增量保存
# true: 定期自动保存当前建图结果(包括SCD和位姿)
# false: 仅在手动调用或退出时保存
# 建议: 长时间运行(>10分钟)务必启用
enable_incremental_save: true

# 增量保存间隔 (关键帧数量)
# 每隔指定数量的关键帧自动保存一次
# 建议: 200-300帧 (约200-300米,取决于keyframe_dist_threshold)
# 对于1.0m关键帧阈值,200帧约覆盖200米距离
incremental_save_interval: 200

# 增量保存路径
# 增量保存文件的存放目录
# 保存内容: pcd/(点云), scd/(描述子), optimized_pose.txt(位姿)
# 这些数据可直接用于重定位功能
incremental_save_path: "/home/li/maps/incremental"

# ==============================================================================
# 第十三部分：系统监控配置
# ==============================================================================
# 控制系统状态信息的输出,便于GUI监控

# 是否启用系统监控
# true: 定期输出系统状态信息(关键帧数、内存占用等)
# false: 减少日志输出
enable_system_monitor: true

# 监控信息输出频率 (单位: Hz)
# 系统状态信息的输出频率
# 0.2 Hz = 每5秒输出一次
monitor_frequency: 0.2

# ==============================================================================
# 第十四部分：重定位配置
# ==============================================================================
# 重定位功能允许在已建地图中自动确定初始位姿
# 适用于机器人重启后恢复位置或在已知环境中直接导航

relocalization:
  # 启动时是否自动重定位
  # true: 节点启动时尝试在先验地图中定位
  # false: 从原点开始新建图
  enable_on_startup: false

  # 先验地图路径
  # 指向之前保存的地图目录,需包含:
  # - scd/目录 (ScanContext描述子)
  # - optimized_pose.txt (位姿文件)
  # - GlobalMap.pcd (可选,用于ICP精化)
  # 空字符串表示禁用重定位
  prior_map_path: "/home/li/maps"

  # ScanContext匹配阈值
  # 用于在先验地图中查找相似位置
  # 范围: 0-1,值越小越严格
  # 建议: 比loop的sc_dist_threshold稍大,0.20-0.30
  sc_match_threshold: 0.25

  # ICP精化阈值
  # 用于验证和精化重定位结果
  # 建议: 与icp_fitness_threshold相近
  icp_refine_threshold: 0.5

  # 最大尝试次数
  # 重定位失败后的重试次数
  # 超过此次数后放弃重定位,从原点开始建图
  max_attempts: 10

  # 超时时间 (单位: 秒)
  # 重定位的最大允许时间
  # 超时后放弃重定位
  timeout_sec: 30.0

  # 是否使用全局地图进行ICP
  # true: 使用GlobalMap.pcd进行ICP精化(更稳定但需要更多内存)
  # false: 使用关键帧点云进行ICP
  use_global_map_icp: true

# ==============================================================================
# 参数调优指南
# ==============================================================================
#
# 1. 室内小场景 (办公室、家庭):
#    lidar_max_range: 15.0
#    cube_len: 100
#    keyframe_dist_threshold: 0.5
#    loop_search_radius: 8.0
#
# 2. 室内大场景 (商场、仓库):
#    lidar_max_range: 30.0
#    cube_len: 200
#    keyframe_dist_threshold: 1.0
#    loop_search_radius: 15.0
#
# 3. 室外场景:
#    lidar_max_range: 80.0
#    cube_len: 500
#    keyframe_dist_threshold: 2.0
#    loop_search_radius: 25.0
#
# 4. 低配硬件 (Jetson Nano/Orin):
#    lidar_filter_num: 8
#    scan_resolution: 0.2
#    max_keyframes_with_cloud: 200
#    loop_closure_frequency: 0.5
#
# 5. 高精度模式:
#    lidar_filter_num: 3
#    scan_resolution: 0.1
#    ieskf_max_iter: 5
#    sc_dist_threshold: 0.15
#
# ==============================================================================
